ğŸ”°æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚
ã“ã“ã§ã¯ã€Œç¬¬1æ®µéšã‚’â€œç¢ºå®Ÿã«ãƒ»å®‰å…¨ã«ãƒ»çŸ­æœŸé–“ã§â€å®Ÿæ–½ã™ã‚‹ãŸã‚ã®å®Ÿå‹™æ‰‹é †ã€ã‚’ã€é †ç•ªãƒ»æ³¨æ„ç‚¹ãƒ»åŠ¹ç‡åŒ–æ‰‹æ®µã¾ã§å«ã‚ã¦æ•´ç†ã—ã¾ã™ã€‚
èª­ã¿çµ‚ãˆãŸæ™‚ç‚¹ã§ã€Œã“ã®é †ã§ã‚„ã‚Œã°äº‹æ•…ã‚‰ãªã„ã€ã¨èª¬æ˜ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã«ã—ã¾ã™ã€‚


---

ğŸ”° ç¬¬1æ®µéšï¼šå®Ÿæ–½æ‰‹é †ï¼ˆå®Œå…¨ç‰ˆãƒ»å®Ÿå‹™å‘ã‘ï¼‰

å…¨ä½“åƒï¼ˆæœ€åˆã«ä¿¯ç°ï¼‰

ã‚„ã‚‹ã“ã¨ã¯4ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã§ã™ã€‚

1. äº‹å‰æ•´ç†ï¼ˆã‚¿ã‚°è¨­è¨ˆãƒ»å½±éŸ¿ç¯„å›²ç¢ºèªï¼‰


2. envã‚¿ã‚°ã®ä»˜ä¸ï¼ˆåŠ¹ç‡çš„ã«ï¼‰


3. Permission Setï¼ˆ6ç¨®ï¼‰ã®ä½œæˆ


4. Identity Center ã¸ã®å‰²ã‚Šå½“ã¦ã¨æ¤œè¨¼



> â— é‡è¦
IAMãƒãƒªã‚·ãƒ¼ã‚’ã„ããªã‚Šå³ã—ãã—ãªã„
â†’ æœ€åˆã¯ã€ŒAdmin + Cross-Env Denyã€ã ã‘
â†’ æ—¢å­˜æ¥­å‹™ã‚’æ­¢ã‚ãªã„ã“ã¨ãŒæœ€å„ªå…ˆ




---

â‘  äº‹å‰æ•´ç†ï¼ˆå¿…é ˆãƒ»30åˆ†ã€œ1æ™‚é–“ï¼‰

1-1. envã‚¿ã‚°ã®ãƒ«ãƒ¼ãƒ«ã‚’æ˜æ–‡åŒ–ï¼ˆå…ˆã«æ±ºã‚ã‚‹ï¼‰

å¿…ãš 1ç¨®é¡ã«çµ±ä¸€ ã—ã¦ãã ã•ã„ã€‚

ã‚­ãƒ¼   : env
å€¤     : dev | stg | prod

âŒ environment / Env / stage ãªã©æ··åœ¨ã•ã›ãªã„
â†’ ABACãŒç ´ç¶»ã—ã¾ã™


---

1-2. ã€Œä»Šã©ã‚ŒãŒæœ¬ç•ªã‹ã€ã‚’ä¸€è¦§åŒ–ï¼ˆå®Œç’§ã§ãªãã¦ã‚ˆã„ï¼‰

Excel / ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§OKã€‚

ã‚µãƒ¼ãƒ“ã‚¹	ãƒªã‚½ãƒ¼ã‚¹å	ç’°å¢ƒ	å‚™è€ƒ

EC2	web-01	prod	æœ¬ç•ª
S3	app-log	prod	æœ¬ç•ª
RDS	db-test	stg	æ¤œè¨¼


> â— 100%æ­£ç¢ºã§ãªãã¦ã„ã„
â†’ ç¬¬1æ®µéšã§ã¯ã€Œæ˜ã‚‰ã‹ã«prodãªã‚‚ã®ã€ã‹ã‚‰ä»˜ã‘ã‚‹




---

â‘¡ envã‚¿ã‚°ä»˜ä¸ï¼ˆåŠ¹ç‡çš„ãªã‚„ã‚Šæ–¹è¾¼ã¿ï¼‰

2-1. ã‚¿ã‚°ä»˜ã‘ã®å„ªå…ˆé †ä½ï¼ˆé‡è¦ï¼‰

ã™ã¹ã¦ä¸€æ°—ã«ã‚„ã‚‰ãªã„ã€‚å„ªå…ˆé †ä½ã‚ã‚Šã€‚

å„ªå…ˆåº¦ é«˜ï¼ˆã¾ãšã‚„ã‚‹ï¼‰

EC2

RDS / Aurora

S3

ALB / NLB

Lambda

DynamoDB


â†’ èª¤æ“ä½œã®å½±éŸ¿ãŒå¤§ãã„ã‚‚ã®

å„ªå…ˆåº¦ ä¸­

EBS

EFS

CloudWatch Log Group

SQS / SNS


å„ªå…ˆåº¦ ä½ï¼ˆç¬¬1æ®µéšã§ã¯å¾Œå›ã—å¯ï¼‰

IAMï¼ˆâ€»ABACåŠ¹ã‹ãªã„ï¼‰

Route53

CloudTrail

Organizations é–¢é€£



---

2-2. ä¸€ç•ªåŠ¹ç‡ãŒè‰¯ã„ã‚¿ã‚°ä»˜ã‘æ–¹æ³•ï¼ˆå®Ÿå‹™ï¼‰

âœ… æ–¹æ³•â‘ ï¼šTag Editorï¼ˆæœ€æ¨å¥¨ï¼‰

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ Resource Groups â†’ Tag Editor

æ‰‹é †ï¼š

1. å¯¾è±¡ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ


2. ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã¾ã¨ã‚ã¦é¸æŠï¼ˆEC2, RDS, S3 ãªã©ï¼‰


3. ãƒ•ã‚£ãƒ«ã‚¿ã§åå‰ãƒ»æ—¢å­˜ã‚¿ã‚°ã§çµã‚‹


4. è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸€æ‹¬é¸æŠ


5. env=prod ãªã©ã‚’ä¸€æ‹¬ä»˜ä¸



ğŸ‘‰ æ•°ç™¾ãƒªã‚½ãƒ¼ã‚¹ã§ã‚‚æ•°åˆ†


---

âœ… æ–¹æ³•â‘¡ï¼šã‚µãƒ¼ãƒ“ã‚¹å€‹åˆ¥ä¸€æ‹¬ï¼ˆEC2ãªã©ï¼‰

ä¾‹ï¼šEC2

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸€è¦§ â†’ è¤‡æ•°é¸æŠ â†’ ã‚¿ã‚° â†’ ä¸€æ‹¬ç·¨é›†



---

â–³ æ–¹æ³•â‘¢ï¼šCLIï¼ˆæ…£ã‚Œã¦ã„ã‚‹äººå‘ã‘ï¼‰

aws ec2 create-tags \
  --resources i-xxxx i-yyyy \
  --tags Key=env,Value=prod

â€» ç¬¬1æ®µéšã§ã¯ ç„¡ç†ã«CLIä¸è¦


---

2-3. ã€Œã¾ã envã‚¿ã‚°ãŒä»˜ã„ã¦ãªã„ãƒªã‚½ãƒ¼ã‚¹ã€ã¸ã®è€ƒãˆæ–¹

envã‚¿ã‚°ãŒãªã„ = ã©ã®ç’°å¢ƒã§ã‚‚æ“ä½œä¸å¯ã«ãªã‚Šã†ã‚‹

ãŸã ã—ç¬¬1æ®µéšã§ã¯ Admin + Denyæ¡ä»¶ä»˜ããªã®ã§å³æ­»ã—ãªã„


ğŸ‘‰ å¾Œã‹ã‚‰é †æ¬¡ä»˜ã‘ã‚Œã°OK


---

â‘¢ Permission Setï¼ˆ6ç¨®ï¼‰ã®ä½œæˆ

3-1. ä½œã‚‹Permission Setä¸€è¦§ï¼ˆç¢ºå®šï¼‰

dev-AdministratorAccess
stg-AdministratorAccess
prod-AdministratorAccess

dev-ReadOnlyAccess
stg-ReadOnlyAccess
prod-ReadOnlyAccess


---

3-2. å„ Permission Set ã«ä»˜ã‘ã‚‹ã‚‚ã®ï¼ˆå…±é€šï¼‰

(1) AWSç®¡ç†ãƒãƒªã‚·ãƒ¼ï¼ˆ1ã¤ï¼‰

AdministratorAccess
ã¾ãŸã¯

ReadOnlyAccess


(2) Cross-Env Deny ãƒãƒªã‚·ãƒ¼ï¼ˆ1ã¤ï¼‰

ä¾‹ï¼šdev ç”¨

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyProdAndStg",
      "Effect": "Deny",
      "Action": "*",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "aws:ResourceTag/env": ["prod", "stg"]
        }
      }
    }
  ]
}

â€» stg / prod ã‚‚åŒæ§˜ã«å€¤ã ã‘å¤‰ãˆã‚‹


---

3-3. ã“ã®è¨­è¨ˆãŒã€Œå®‰å…¨ã€ãªç†ç”±

Allow ã‚’å‰Šã‚‰ãªã„

Deny ã ã‘è¿½åŠ 

Deny ã¯ ã‚¿ã‚°ãŒã‚ã‚‹ã‚‚ã®ã ã‘ã«åŠ¹ã


ğŸ‘‰ æ—¢å­˜æ¥­å‹™ãŒæ­¢ã¾ã‚Šã«ãã„


---

â‘£ Identity Center ã¸ã®å‰²ã‚Šå½“ã¦

4-1. å‰²ã‚Šå½“ã¦æ–¹é‡ï¼ˆç¾å®Ÿçš„ï¼‰

é€šå¸¸ä½œæ¥­è€…
â†’ dev-Admin / stg-Admin

æœ¬ç•ªä½œæ¥­è€…
â†’ prod-Adminï¼ˆé™å®šäººæ•°ï¼‰

é–²è¦§è€…
â†’ *-ReadOnly



---

4-2. AWS Access Portal ã§ã®è¦‹ãˆæ–¹

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ï¼š

1. Access Portal ã«ãƒ­ã‚°ã‚¤ãƒ³


2. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠ


3. Permission Setï¼ˆdev/stg/prod + æ¨©é™ï¼‰ã‚’é¸æŠ


4. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸å…¥ã‚‹



â†’ ç’°å¢ƒã®å–ã‚Šé•ãˆãŒæ¿€æ¸›


---

â‘¤ æ¤œè¨¼ï¼ˆå¿…é ˆãƒ»ã“ã“ã§æ­¢ã‚ã¦ã‚‚OKï¼‰

æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

[ ] dev-Admin ã§ prod ã® EC2 ãŒè¦‹ãˆãªã„ / æ“ä½œä¸å¯

[ ] prod-ReadOnly ã§å¤‰æ›´ç³»ãŒæ‹’å¦ã•ã‚Œã‚‹

[ ] envã‚¿ã‚°ãªã—ãƒªã‚½ãƒ¼ã‚¹ãŒã©ã†è¦‹ãˆã‚‹ã‹ç¢ºèª

[ ] CloudTrail ã« AssumeRole ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹



---

â‘¥ ç¬¬1æ®µéšã‚’ã€Œå®Œäº†ã€ã¨ã™ã‚‹åŸºæº–

ä»¥ä¸‹ã‚’æº€ãŸã›ã° ä¸€æ—¦æ­¢ã‚ã¦OK ã§ã™ã€‚

envã‚¿ã‚°ãŒä¸»è¦ãƒªã‚½ãƒ¼ã‚¹ã«ä»˜ã„ãŸ

dev/stg/prod ã® Permission Set ãŒå­˜åœ¨

Cross-Env Deny ãŒåŠ¹ã„ã¦ã„ã‚‹

æ¥­å‹™ãŒæ­¢ã¾ã£ã¦ã„ãªã„



---

âœ… ã¾ã¨ã‚ï¼ˆä¸Šå¸ãƒ»ç¬¬ä¸‰è€…å‘ã‘ä¸€è¨€ï¼‰

> ã€Œã¾ãšã¯ã‚¿ã‚°ï¼‹Permission Setï¼‹Denyã ã‘ã§ã€
æœ¬ç•ªèª¤æ“ä½œã‚’â€œæ§‹é€ çš„ã«ä¸å¯èƒ½â€ã«ã—ã¾ã—ãŸã€‚
æ—¢å­˜æ¥­å‹™ã¯å¤‰ãˆãšã€å®‰å…¨è£…ç½®ã ã‘è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã€




---

å¿…è¦ã§ã‚ã‚Œã°æ¬¡ã«ï¼š

ã€Œenvã‚¿ã‚°ã‚’ä»˜ã‘ã‚‰ã‚Œãªã„ä»£è¡¨çš„ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§ã¨æ‰±ã„ã€

ã€ŒDenyãŒåŠ¹ãã™ããŸæ™‚ã®åˆ‡ã‚Šæˆ»ã—æ‰‹é †ã€

ã€ŒCloudTrailã§ã®ç¢ºèªæ–¹æ³•ï¼ˆç”»é¢ä»˜ãèª¬æ˜ï¼‰ã€

ã€Œç¬¬1æ®µéšã ã‘ã§çµ‚ã‚ã‚‹å ´åˆã®â€œæœ€çµ‚å½¢â€ã€


ã‚‚èª¬æ˜ã§ãã¾ã™ã€‚
æ¬¡ã¯ã©ã“ã‚’æ·±æ˜ã‚Šã—ã¾ã™ã‹ã€‚


---------------------

aws resourcegroupstaggingapi get-resources \
  --tag-filters Key=YourTagKey \
  --region ap-northeast-1


aws resourcegroupstaggingapi get-resources \
  --tag-filters Key=YourTagKey \
  --region ap-northeast-1 \
  --query "ResourceTagMappingList[].ResourceARN" \
  --output table
