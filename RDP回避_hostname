#!/bin/bash

REGION="ap-northeast-1"

# ===== ここで配列を定義 =====
PROFILES=("prod" "prod" "dev")
INSTANCE_IDS=("i-0123456789abcdef0" "i-0abcdef0123456789" "i-0123aaaa4567bbbbc")
INSTANCE_NAMES=("web-prod-01" "web-prod-02" "web-dev-01")

# ===== 配列のインデックスで2重ループ相当 =====
for i in "${!PROFILES[@]}"; do
  PROFILE="${PROFILES[$i]}"
  INSTANCE_ID="${INSTANCE_IDS[$i]}"
  INSTANCE_NAME="${INSTANCE_NAMES[$i]}"

  echo "========================================"
  echo "使用プロファイル: $PROFILE"
  echo "対象インスタンス: $INSTANCE_NAME ($INSTANCE_ID)"

  COMMAND_ID=$(aws ssm send-command \
    --profile "$PROFILE" \
    --document-name "AWS-RunPowerShellScript" \
    --instance-ids "$INSTANCE_ID" \
    --parameters commands="hostname" \
    --region "$REGION" \
    --query "Command.CommandId" \
    --output text)

  # 失敗時のガード（SSM未対応など）
  if [ -z "$COMMAND_ID" ] || [ "$COMMAND_ID" = "None" ]; then
    echo "⚠️ SSMコマンド送信に失敗しました。スキップします。"
    continue
  fi

  # 実行結果取得（少し待つ）
  sleep 2

  # 非同期のため簡易リトライ
  for retry in {1..5}; do
    HOSTNAME=$(aws ssm get-command-invocation \
      --profile "$PROFILE" \
      --command-id "$COMMAND_ID" \
      --instance-id "$INSTANCE_ID" \
      --region "$REGION" \
      --query "StandardOutputContent" \
      --output text 2>/dev/null)

    if [ -n "$HOSTNAME" ] && [ "$HOSTNAME" != "None" ]; then
      break
    fi
    sleep 2
  done

  echo "hostname: $HOSTNAME"
  echo ""

done

ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー

🎯 ① まず「現状の問題」を短く

現在、複数アカウントにまたがるWindows EC2の hostname を確認するには、
RDPで1台ずつログインして手作業で確認する必要があります。

これには以下の問題があります。

作業工数が非常に大きい（台数が増えるほど比例して増える）

ヒューマンエラーが起きやすい（見落とし・転記ミス）

誰が何を確認したか証跡が残らない

セキュリティ的にもRDP常用は好ましくない

🚀 ② 提案内容（シンプルに）

そこで、
各EC2に AmazonSSMManagedInstanceCore を付与し、
AWS Systems Manager（SSM） から
hostname を一括取得できる仕組みを導入したいと考えています。

💡 ③ 何が良くなるのか（上司が一番知りたい所）
観点	効果
工数削減	これまで数時間かかっていた棚卸しが数分で完了
属人性排除	誰がやっても同じ手順・同じ結果
セキュリティ	RDP接続・ポート開放不要
監査対応	実行履歴がログとして残る
将来性	hostname以外にも、パッチ適用・設定確認に流用可能

👉
「今回のhostname取得は第一歩で、将来的に運用自動化の土台になります」
ここ、かなり評価ポイント高いです。

💰 ④ コスト面の説明（突っ込まれやすい所）

SSMのRun Command自体は基本無料です。
NAT Gateway や VPCエンドポイント経由の通信は発生しますが、
hostname実行レベルの通信量は非常に少なく、
既存のWindows Update通信などと比べても無視できるレベルです。

一方で、人手によるRDP作業の工数削減効果の方が圧倒的に大きいです。

🧠 ⑤ リスクがないことも先回りで説明

既存EC2へのIAMロール追加は、
アプリケーションやOSの動作には影響ありません。

影響範囲は限定的で、
万一SSMを使わなくなってもロールを外すだけで元に戻せます。

🧪 ⑥ 段階導入を提案（安心感を出す）

まずは検証環境や一部アカウントで試験導入し、
問題がなければ本番へ展開する形を想定しています。
