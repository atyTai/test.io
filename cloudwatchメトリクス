çŠ¶æ³ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
çµè«–ã‹ã‚‰è¨€ã†ã¨ CloudWatch ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ã‚’ãã®ã¾ã¾è‡ªå‹•åŒ–ã™ã‚‹ã®ã¯éæ¨å¥¨ ã§ã€
CloudWatch API ã‹ã‚‰ã‚°ãƒ©ãƒ•ç”»åƒï¼ˆPNGï¼‰ã‚’ç›´æ¥ç”Ÿæˆãƒ»ä¿å­˜ã™ã‚‹æ–¹æ³•ãŒæœ€é©è§£ã§ã™ã€‚
ä»¥ä¸‹ã€
1ï¸âƒ£ ãªãœã‚³ãƒ³ã‚½ãƒ¼ãƒ«SSè‡ªå‹•åŒ–ãŒå¾®å¦™ã‹
2ï¸âƒ£ æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
3ï¸âƒ£ å…·ä½“çš„ãªCLI / Pythonä¾‹
4ï¸âƒ£ ã‚ˆãã‚ã‚‹æ‹¡å¼µãƒ»æ³¨æ„ç‚¹
ã®é †ã§æ•´ç†ã—ã¾ã™ã€‚
1ï¸âƒ£ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè‡ªå‹•åŒ–ãŒå¾®å¦™ãªç†ç”±
æŠ€è¡“çš„ã«ã¯ä»¥ä¸‹ã‚‚å¯èƒ½ã§ã™ï¼š
Selenium / Playwright ã§AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ“ä½œ
headless Chromeã§ã‚¹ã‚¯ã‚·ãƒ§å–å¾—
ã—ã‹ã— æ¥­å‹™ç”¨é€”ã§ã¯éæ¨å¥¨ã§ã™ã€‚
ç†ç”±ï¼š
IAM Identity Center / MFA / ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™ã§ä¸å®‰å®š
UIå¤‰æ›´ã«éå¸¸ã«å¼±ã„
å®Ÿè¡Œç’°å¢ƒæ§‹ç¯‰ãŒé‡ã„ï¼ˆChrome + driverï¼‰
AWSçš„ã«ã€Œæƒ³å®šã•ã‚Œã¦ã„ãªã„ä½¿ã„æ–¹ã€
ğŸ‘‰ CloudWatchã¯ã€Œç”»åƒå‡ºåŠ›APIã€ã‚’å…¬å¼ã«æä¾›ã—ã¦ã„ã¾ã™
2ï¸âƒ£ æ¨å¥¨æ§‹æˆï¼ˆæ­£æ”»æ³•ï¼‰
âœ” CloudWatch GetMetricWidgetImage API ã‚’ä½¿ã†
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹

CloudWatch
 â””â”€ GetMetricWidgetImage
     â””â”€ PNGç”»åƒã¨ã—ã¦ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ
         â””â”€ ãƒ­ãƒ¼ã‚«ãƒ« or S3 ã«ä¿å­˜
ã§ãã‚‹ã“ã¨
ãƒ¡ãƒˆãƒªã‚¯ã‚¹æŒ‡å®š
æœŸé–“ï¼ˆstart / end or relativeï¼‰
çµ±è¨ˆå€¤ï¼ˆAverage, Maximumãªã©ï¼‰
è¤‡æ•°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’1ç”»åƒã«ã¾ã¨ã‚ã‚‹
ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‰²ãƒ»ã‚µã‚¤ã‚ºæŒ‡å®š
ğŸ‘‰ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¦‹ã¦ã„ã‚‹ã‚°ãƒ©ãƒ•ã¨ã»ã¼åŒç­‰
3ï¸âƒ£ å®Ÿè£…ä¾‹
â‘  AWS CLIï¼ˆå˜ç™ºãƒ»æ¤œè¨¼å‘ã‘ï¼‰
widget.json
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
Json
{
  "width": 800,
  "height": 400,
  "start": "-PT6H",
  "end": "PT0H",
  "title": "EC2 CPU Utilization",
  "metrics": [
    [ "AWS/EC2", "CPUUtilization", "InstanceId", "i-xxxxxxxx" ]
  ],
  "stat": "Average",
  "period": 300
}
CLIå®Ÿè¡Œ
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
Bash
aws cloudwatch get-metric-widget-image \
  --metric-widget file://widget.json \
  --output-format png \
  output.png
â¡ output.png ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
â‘¡ Pythonï¼ˆæœ¬å‘½ãƒ»è‡ªå‹•åŒ–å‘ã‘ï¼‰
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
Python
import boto3
import json
from datetime import datetime

cloudwatch = boto3.client("cloudwatch")

widget = {
    "width": 800,
    "height": 400,
    "start": "-PT24H",
    "end": "PT0H",
    "title": "ALB RequestCount",
    "metrics": [
        ["AWS/ApplicationELB", "RequestCount", "LoadBalancer", "app/xxx"]
    ],
    "stat": "Sum",
    "period": 300
}

response = cloudwatch.get_metric_widget_image(
    MetricWidget=json.dumps(widget),
    OutputFormat="png"
)

filename = f"alb_request_{datetime.now():%Y%m%d_%H%M}.png"
with open(filename, "wb") as f:
    f.write(response["MetricWidgetImage"])
â‘¢ è¤‡æ•°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ Ã— è¤‡æ•°æœŸé–“ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
Python
periods = ["-PT1H", "-PT6H", "-P1D"]
metrics = [
    ("AWS/EC2", "CPUUtilization"),
    ("AWS/EC2", "NetworkIn")
]

for start in periods:
    for ns, metric in metrics:
        widget["start"] = start
        widget["title"] = f"{metric} ({start})"

        response = cloudwatch.get_metric_widget_image(
            MetricWidget=json.dumps(widget),
            OutputFormat="png"
        )

        with open(f"{metric}_{start}.png", "wb") as f:
            f.write(response["MetricWidgetImage"])
4ï¸âƒ£ ä¿å­˜å…ˆã®é¸æŠè‚¢
âœ” ãƒ­ãƒ¼ã‚«ãƒ«
ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
æ‰‹å‹•ç¢ºèªç”¨
âœ” S3ï¼ˆãŠã™ã™ã‚ï¼‰
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
Python
s3 = boto3.client("s3")
s3.put_object(
    Bucket="my-report-bucket",
    Key=f"cloudwatch/{filename}",
    Body=response["MetricWidgetImage"],
    ContentType="image/png"
)
â¡
ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
Athena / Glue é€£æº
Slack / ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã¨ç›¸æ€§â—
5ï¸âƒ£ ã‚ˆãã‚ã‚‹æ‹¡å¼µãƒ‘ã‚¿ãƒ¼ãƒ³
è¦ä»¶
å®Ÿç¾æ–¹æ³•
å®šæœŸå®Ÿè¡Œ
EventBridge + Lambda
Excel / PPT
Pythonã§è²¼ã‚Šä»˜ã‘
éšœå®³æ™‚ã®ã¿å–å¾—
Alarm â†’ Lambda
1ç”»é¢ã«è¤‡æ•°
metricsé…åˆ—ã«è¤‡æ•°å®šç¾©
è‰²æŒ‡å®š
"color": "#ff0000"
6ï¸âƒ£ çµè«–ï¼ˆé‡è¦ï¼‰
âœ… ã‚„ã‚‹ã¹ãæ–¹æ³•
CloudWatch GetMetricWidgetImage
CLI / Pythonã§å®Œå…¨è‡ªå‹•åŒ–
âŒ é¿ã‘ã‚‹ã¹ãæ–¹æ³•
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè‡ªå‹•æ“ä½œ
ã‚‚ã—ã‚ˆã‘ã‚Œã°æ¬¡ã«ï¼š
ã€Œä»Šã‚„ã£ã¦ã„ã‚‹æ‰‹ä½œæ¥­ã®å…·ä½“ä¾‹ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»æœŸé–“ãƒ»ä¿å­˜å…ˆï¼‰ã€
ã€ŒLambdaåŒ– or ãƒ­ãƒ¼ã‚«ãƒ«cronã‹ã€
ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã‚Œã° ãã®ã¾ã¾ä½¿ãˆã‚‹å®Œæˆå½¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¾ã§è½ã¨ã—ã¾ã™ã€‚
